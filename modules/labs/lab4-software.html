<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab 4 (Software Stream) for Advanced Deep Learning Systems (ADLS) &mdash; MASE 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ADLS Docker Environment Setup" href="setup_docker_env.html" />
    <link rel="prev" title="Lab 4 (Hardware Stream) for Advanced Deep Learning Systems (ADLS)" href="lab4-hardware.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MASE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/specifications.html">Coding Style Specifications</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machop API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/actions.html">Chop Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/passes.html">Chop Passes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/ir.html">IR</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Mase Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hardware/hardware_documentation.html">Hardware Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Students</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../labs.html">Advanced Deep Learning Systems Labs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lab1.html">Lab 1 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab2.html">Lab 2 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab3.html">Lab 3 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lab4-hardware.html">Lab 4 (Hardware Stream) for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Lab 4 (Software Stream) for Advanced Deep Learning Systems (ADLS)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-introduction">General introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-network-architecture-search">What is Network Architecture Search?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-handwritten-jsc-network">A Handwritten JSC Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#model-architecture-modification-as-a-transformation-pass">Model Architecture Modification as a Transformation Pass</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-task-scaling-the-search-to-real-networks">Optional task (scaling the search to real networks)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="setup_docker_env.html">ADLS Docker Environment Setup</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MASE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../labs.html">Advanced Deep Learning Systems Labs</a></li>
      <li class="breadcrumb-item active">Lab 4 (Software Stream) for Advanced Deep Learning Systems (ADLS)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/modules/labs/lab4-software.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <a class="reference internal image-reference" href="../../_images/deepwok.png"><img alt="logo" class="align-center" src="../../_images/deepwok.png" style="width: 160.0px; height: 160.0px;" /></a>
<section id="lab-4-software-stream-for-advanced-deep-learning-systems-adls">
<h1>Lab 4 (Software Stream) for Advanced Deep Learning Systems (ADLS)<a class="headerlink" href="#lab-4-software-stream-for-advanced-deep-learning-systems-adls" title="Link to this heading"></a></h1>
<div align="center">
<p align="center">
   ELEC70109/EE9-AML3-10/EE9-AO25
   <br />
Written by
   <a href="https://aaron-zhao123.github.io/">Aaron Zhao </a> ,
   <a href="https://chengzhang-98.github.io/blog/">Cheng Zhang </a> ,
   <a href="https://www.pedrogimenes.co.uk/">Pedro Gimenes </a>
</p>
</div><section id="general-introduction">
<h2>General introduction<a class="headerlink" href="#general-introduction" title="Link to this heading"></a></h2>
<p>In this lab, you will learn how to use the search functionality in the
software stack of MASE to implement a Network Architecture Search.</p>
<p>There are in total 4 tasks you would need to finish, there is also 1
optional task.</p>
</section>
<section id="what-is-network-architecture-search">
<h2>What is Network Architecture Search?<a class="headerlink" href="#what-is-network-architecture-search" title="Link to this heading"></a></h2>
<p>The design of a network architecture can greatly impact the performance
of the model. Consider the following optimization problem:</p>
<p><span class="math notranslate nohighlight">\(\min_{a \in \mathcal{A}} \mathcal{L}_{val}(w^*(a), a)\)</span></p>
<p><span class="math notranslate nohighlight">\(s.t.~w^*(a) = \argmin_{w}(\mathcal{L}_{train}(w, a))\)</span></p>
<p>For an architecture <span class="math notranslate nohighlight">\(a\)</span> sampled from a set of architectures
<span class="math notranslate nohighlight">\(\mathcal{A}\)</span>, we are minimizing the loss value when the
architecture <span class="math notranslate nohighlight">\(a\)</span> is parameterized by <span class="math notranslate nohighlight">\(w^*(a)\)</span>.</p>
<p>Meanwhile, the parameters <span class="math notranslate nohighlight">\(w^*(a)\)</span> is the particular
parameterization that provides the lowest <span class="math notranslate nohighlight">\(\mathcal{L}_{train}\)</span>
given the architecture <span class="math notranslate nohighlight">\(a\)</span>.</p>
<p>This is the core optimization problem involved in Network Architecture
Search, where several approximations can happen. For instance, we can
approximate <span class="math notranslate nohighlight">\(\mathcal{L}_{train}\)</span> or <span class="math notranslate nohighlight">\(\mathcal{L}_{val}\)</span>, or
the <span class="math notranslate nohighlight">\(\min_{a \in \mathcal{A}}\)</span> can be formulated as a
reinforcement learning process and so on.</p>
<section id="a-handwritten-jsc-network">
<h3>A Handwritten JSC Network<a class="headerlink" href="#a-handwritten-jsc-network" title="Link to this heading"></a></h3>
<p>We follow a similar procedure of what you have tried in lab3 to setup
the dataset, copy and paste the following code snippet to a file, and
name it <code class="docutils literal notranslate"><span class="pre">lab4.py</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>

<span class="c1"># figure out the correct path</span>
<span class="n">machop_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span><span class="s2">&quot;machop&quot;</span>
<span class="k">assert</span> <span class="n">machop_path</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s2">&quot;Failed to find machop at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machop_path</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">machop_path</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">chop.dataset</span> <span class="kn">import</span> <span class="n">MaseDataModule</span><span class="p">,</span> <span class="n">get_dataset_info</span>
<span class="kn">from</span> <span class="nn">chop.tools.logger</span> <span class="kn">import</span> <span class="n">set_logging_verbosity</span><span class="p">,</span> <span class="n">get_logger</span>

<span class="kn">from</span> <span class="nn">chop.passes.graph.analysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">report_node_meta_param_analysis_pass</span><span class="p">,</span>
    <span class="n">profile_statistics_analysis_pass</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">chop.passes.graph</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">add_common_metadata_analysis_pass</span><span class="p">,</span>
    <span class="n">init_metadata_analysis_pass</span><span class="p">,</span>
    <span class="n">add_software_metadata_analysis_pass</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">chop.tools.get_input</span> <span class="kn">import</span> <span class="n">InputGenerator</span>
<span class="kn">from</span> <span class="nn">chop.ir.graph.mase_graph</span> <span class="kn">import</span> <span class="n">MaseGraph</span>

<span class="kn">from</span> <span class="nn">chop.models</span> <span class="kn">import</span> <span class="n">get_model_info</span><span class="p">,</span> <span class="n">get_model</span>

<span class="n">set_logging_verbosity</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;chop&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;jsc-tiny&quot;</span>
<span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;jsc&quot;</span>


<span class="n">data_module</span> <span class="o">=</span> <span class="n">MaseDataModule</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">data_module</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
<span class="n">data_module</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="n">model_info</span> <span class="o">=</span> <span class="n">get_model_info</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

<span class="n">input_generator</span> <span class="o">=</span> <span class="n">InputGenerator</span><span class="p">(</span>
    <span class="n">data_module</span><span class="o">=</span><span class="n">data_module</span><span class="p">,</span>
    <span class="n">model_info</span><span class="o">=</span><span class="n">model_info</span><span class="p">,</span>
    <span class="n">task</span><span class="o">=</span><span class="s2">&quot;cls&quot;</span><span class="p">,</span>
    <span class="n">which_dataloader</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dummy_in</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data_module</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]}</span>
</pre></div>
</div>
<p>This time we are going to use a slightly different network, so we define
it as a Pytorch model, copy and paste this snippet also to <code class="docutils literal notranslate"><span class="pre">lab4.py</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MASE integrates seamlessly with native Pytorch models.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">chop.passes.graph.utils</span> <span class="kn">import</span> <span class="n">get_parent_name</span>

<span class="c1"># define a new model</span>
<span class="k">class</span> <span class="nc">JSC_Three_Linear_Layers</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JSC_Three_Linear_Layers</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 0</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 1</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>  <span class="c1"># linear  2</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>  <span class="c1"># linear  3</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>   <span class="c1"># linear  4</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>  <span class="c1"># 5</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">JSC_Three_Linear_Layers</span><span class="p">()</span>

<span class="c1"># generate the mase graph and initialize node metadata</span>
<span class="n">mg</span> <span class="o">=</span> <span class="n">MaseGraph</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
<span class="n">mg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">init_metadata_analysis_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="model-architecture-modification-as-a-transformation-pass">
<h2>Model Architecture Modification as a Transformation Pass<a class="headerlink" href="#model-architecture-modification-as-a-transformation-pass" title="Link to this heading"></a></h2>
<p>Similar to what you have done in <code class="docutils literal notranslate"><span class="pre">lab2</span></code>, one can also implement a
change in model architecture as a transformation pass:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">instantiate_linear</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">in_features</span><span class="p">,</span>
        <span class="n">out_features</span><span class="o">=</span><span class="n">out_features</span><span class="p">,</span>
        <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">redefine_linear_transform_pass</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pass_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">main_config</span> <span class="o">=</span> <span class="n">pass_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">main_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default value must be provided.&quot;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">fx_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># if node name is not matched, it won&#39;t be tracked</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">main_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ori_module</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
            <span class="n">in_features</span> <span class="o">=</span> <span class="n">ori_module</span><span class="o">.</span><span class="n">in_features</span>
            <span class="n">out_features</span> <span class="o">=</span> <span class="n">ori_module</span><span class="o">.</span><span class="n">out_features</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">ori_module</span><span class="o">.</span><span class="n">bias</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_only&quot;</span><span class="p">:</span>
                <span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;channel_multiplier&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="n">in_features</span> <span class="o">=</span> <span class="n">in_features</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;channel_multiplier&quot;</span><span class="p">]</span>
                <span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;channel_multiplier&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;input_only&quot;</span><span class="p">:</span>
                <span class="n">in_features</span> <span class="o">=</span> <span class="n">in_features</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;channel_multiplier&quot;</span><span class="p">]</span>
            <span class="n">new_module</span> <span class="o">=</span> <span class="n">instantiate_linear</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
            <span class="n">parent_name</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">get_parent_name</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent_name</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_module</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="p">{}</span>



<span class="n">pass_config</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
<span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}},</span>
<span class="s2">&quot;seq_blocks_2&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;output_only&quot;</span><span class="p">,</span>
        <span class="c1"># weight</span>
        <span class="s2">&quot;channel_multiplier&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="s2">&quot;seq_blocks_3&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="s2">&quot;channel_multiplier&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="s2">&quot;seq_blocks_4&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;input_only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;channel_multiplier&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># this performs the architecture transformation based on the config</span>
<span class="n">mg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">redefine_linear_transform_pass</span><span class="p">(</span>
    <span class="n">graph</span><span class="o">=</span><span class="n">mg</span><span class="p">,</span> <span class="n">pass_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">pass_config</span><span class="p">})</span>
</pre></div>
</div>
<p>Copy and paste the above coding snippet and run your code. The modified
network features linear layers expanded to double their size, yet it’s
unusual to sequence three linear layers consecutively without
interposing any non-linear activations (do you know why?).</p>
<p>So we are interested in a modified network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define a new model</span>
<span class="k">class</span> <span class="nc">JSC_Three_Linear_Layers</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JSC_Three_Linear_Layers</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 0</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 1</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>  <span class="c1"># linear seq_2</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 3</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>  <span class="c1"># linear seq_4</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>  <span class="c1"># 5</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>  <span class="c1"># linear seq_6</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>  <span class="c1"># 7</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Can you edit your code, so that we can modify the above network to
have layers expanded to double their sizes? Note: you will have to
change the <code class="docutils literal notranslate"><span class="pre">ReLU</span></code> also.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">lab3</span></code>, we have implemented a grid search, can we use the grid
search to search for the best channel multiplier value?</p></li>
<li><p>You may have noticed, one problem with the channel multiplier is that it scales all layers uniformly, ideally, we would like to be able to construct networks like the following:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define a new model</span>
<span class="k">class</span> <span class="nc">JSC_Three_Linear_Layers</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JSC_Three_Linear_Layers</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  <span class="c1"># output scaled by 2</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>  <span class="c1"># scaled by 2</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># input scaled by 2 but output scaled by 4</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>  <span class="c1"># scaled by 4</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>  <span class="c1"># scaled by 4</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_blocks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Can you then design a search so that it can reach a network
that can have this kind of structure?</p>
<ol class="arabic simple" start="4">
<li><p>Integrate the search to the <code class="docutils literal notranslate"><span class="pre">chop</span></code> flow, so we can run it from the
command line.</p></li>
</ol>
</section>
<section id="optional-task-scaling-the-search-to-real-networks">
<h2>Optional task (scaling the search to real networks)<a class="headerlink" href="#optional-task-scaling-the-search-to-real-networks" title="Link to this heading"></a></h2>
<p>We have looked at how to search, on the architecture level, for a simple
linear layer based network. MASE has the following components that you
can have a look:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/DeepWok/mase/blob/main/machop/chop/dataset/vision/cifar.py">Cifar10 dataset</a></p></li>
<li><p><a class="reference external" href="https://github.com/DeepWok/mase/blob/main/machop/chop/models/vision/vgg_cifar/vgg_cifar.py">VGG</a>,
this is a variant used for CIFAR</p></li>
<li><p><a class="reference external" href="https://github.com/DeepWok/mase/blob/main/machop/chop/actions/search/strategies/optuna.py">TPE-based
Search</a>,
implementd using
<a class="reference external" href="https://optuna.readthedocs.io/en/stable/reference/index.html">Optuna</a></p></li>
</ul>
<p>Can you define a search space (maybe channel dimension) for the VGG
network, and use the TPE-search to tune it?</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lab4-hardware.html" class="btn btn-neutral float-left" title="Lab 4 (Hardware Stream) for Advanced Deep Learning Systems (ADLS)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="setup_docker_env.html" class="btn btn-neutral float-right" title="ADLS Docker Environment Setup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, DeepWok.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>